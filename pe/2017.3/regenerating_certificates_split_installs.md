# Regenerating certificates: split installs

In some cases, you may find that you need to regenerate the SSL certificates and security credentials \(private and public keys\) that are generated by PE's built-in certificate authority \(CA\). For example, you may have a Puppet master you need to move to a different network in your infrastructure, or you may find you need to regenerate all the certificates and security credentials in your infrastructure due to an unforeseen security vulnerability.

**Related information**  


[Regenerating certificates: monolithic installs](regenerating_certificates_monolithic_installs.md#)

[Regenerate Puppet agent certificates](regenerate_puppet_agent_certificates.md)

[Generate a custom Diffie-Hellman parameter file](generate_custom_dh_parameter_file.md)

## Regenerate certificates in PE: split installs

You can regenerate all certificates in a split PE deployment including the certificates and keys for the Puppet master, PuppetDB, console, and associated services.

### Before you begin

-   You must be logged in as a root to make these changes.

-   In the following instructions, when `<CERTNAME>` is used, it refers to the agent's certname on each node. To find this value, run `puppet config print certname` before starting.


### About this task

Regenerating your certificates will invalidate all existing authentication tokens. Once the regeneration process is complete, all PE users must generate new authentication tokens.

Regenerating your certificates involves the following tasks:

### Procedure

1.  Back up certificate directories

2.  \(Optional\) Delete and recreate the Puppet certificate authority \(CA\)

3.  Regenerate the Puppet master, console, and PuppetDB certificates

4.  Configure PE


### Back up certificate directories

If something goes wrong during the regeneration process, you may need to restore these directories so your deployment can stay functional. However, if you needed to regenerate your certs for security reasons and couldn't, you should contact Puppet support as soon as you restore service so we can help you secure your site.

#### About this task

#### Procedure

1.  On the Puppet master, back up the following directories:

    -   `/etc/puppetlabs/puppet/ssl/`
    -   `/etc/puppetlabs/orchestration-services/ssl`
2.  On the PuppetDB node, back up the following directories:

    -   `/etc/puppetlabs/puppet/ssl/`
    -   `/etc/puppetlabs/puppetdb/ssl/`
    -   `/opt/puppetlabs/server/data/postgresql/9.6/data/certs/`
3.  On the console, back up the following directories:

    -   `/etc/puppetlabs/puppet/ssl/`
    -   `/opt/puppetlabs/server/data/console-services/certs/`

### \(Optional\) Delete and recreate the Puppet CA

If needed, you can delete and recreate the Puppet CA before regenerating the rest of your monolithic certificates.

#### About this task

CAUTION:

This is an optional step and is an meant for use in the event of a total compromise of your site, or some other unusual circumstance. This **destroys the certificate authority and all other certificates.**

Run the following commands on the Puppet master.

#### Procedure

1.  Delete the CA and clear all certs from your master: `rm -rf /etc/puppetlabs/puppet/ssl/*`

2.  Regenerate the CA: `puppet cert list -a`

    You should see this message: `Notice: Signed certificate request for ca`


### Regenerate the Puppet master certificates

In this step, you'll create the certificates for the split Puppet master.

#### About this task

Run the following commands on the Puppet master.

#### Procedure

1.  Remove the Puppet master's cached catalog: `rm -f /opt/puppetlabs/puppet/cache/client_data/catalog/<CERTNAME>.json`

2.  Clear the cert for the Puppet master:`puppet cert clean <CERTNAME>`

    **Note:** This step is not necessary if you deleted and recreated the CA cert.


### Clear the PuppetDB certificates

In this step, you clear the PuppetDB certificate.

#### Procedure

1.  Remove PuppetDB's cached catalog. On the PuppetDB node, run: `rm -f /opt/puppetlabs/puppet/cache/client_data/catalog/<CERTNAME>.json`

2.  Clear the cert for the PuppetDB node. On the Puppet master, run: `puppet cert clean <CERTNAME>`

3.  Remove the certificates. On the PuppetDB node, run: `rm -f /etc/puppetlabs/puppet/ssl/*/<CERTNAME>.pem`


### Clear the PE console certificates

In this step, you clear the console certificate.

#### Procedure

1.  Remove the console's cached catalog. On the console node, run: `rm -f /opt/puppetlabs/puppet/cache/client_data/catalog/<CERTNAME>.json`

2.  Clear the cert for the console node. On the Puppet master, run: `puppet cert clean <CERTNAME>`

3.  Remove the certificates. On the console node, run: `rm -f /etc/puppetlabs/puppet/ssl/*/<CERTNAME>.pem`


### Update the configuration of PE

In this step, you configure PE to generate new certificates for the component nodes and update PE's configuration.

#### Procedure

1.  On the Puppet master node, run: `puppet infrastructure configure --no-recover`

    **Note:** Be sure to specify any DNS alt names you have in the `pe_install::puppet_master_dnsaltnames` array in `/etc/puppetlabs/enterprise/conf.d/pe.conf`. You can find the list of your current DNS alt names with `puppet cert list <CERTNAME>`. By default, PE uses `puppet` and `puppet.domain`.

2.  On the PuppetDB node, run: `puppet infrastructure configure --no-recover`

3.  On the console node, run: `puppet infrastructure configure --no-recover`

4.  Run Puppet on each node in the following order:

    1.  Puppet master

    2.  PuppetDB

    3.  Console

    A successful Puppet run on each node, in the given order, is necessary to ensure that PE's services are properly configured.


